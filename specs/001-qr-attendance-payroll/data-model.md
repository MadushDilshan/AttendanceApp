# Data Model: QR-Based Attendance & Payroll System

**Feature**: 001-qr-attendance-payroll
**Date**: 2026-02-13
**Database**: MongoDB Atlas (document store, Mongoose ODM)

---

## Collections Overview

| Collection           | Primary Key | Key Relationships |
|----------------------|-------------|-------------------|
| `employees`          | `_id`       | belongs to `workplaces` |
| `workplaces`         | `_id`       | owns many `employees`, many `attendance_records` |
| `attendance_records` | `_id`       | belongs to `employees`, `workplaces` |
| `paysheets`          | `_id`       | generated by `employees` (admin), embeds entries |
| `refresh_tokens`     | `_id`       | belongs to `employees` |

---

## 1. `employees`

Stores both employee and owner/admin accounts.

```typescript
{
  _id:          ObjectId,          // auto-generated
  name:         String,            // required, 2–100 chars
  email:        String,            // required, unique, lowercase, indexed
  passwordHash: String,            // bcrypt hash, never returned in API responses
  role:         'employee' | 'admin',  // required
  status:       'active' | 'inactive', // default: 'active'
  workplaceId:  ObjectId,          // ref: workplaces, required for 'employee' role
  createdAt:    Date,              // auto
  updatedAt:    Date               // auto
}
```

**Indexes**:
- `{ email: 1 }` — unique, used for login lookup
- `{ workplaceId: 1, status: 1 }` — list active employees per workplace

**Validation rules**:
- `email` MUST match RFC 5321 format.
- `passwordHash` MUST be stored; plaintext passwords MUST NOT be persisted.
- `role === 'admin'` accounts do not require a `workplaceId`.

---

## 2. `workplaces`

Represents a physical work location. One QR code per workplace.

```typescript
{
  _id:                  ObjectId,
  name:                 String,       // required, 1–100 chars
  location: {
    type:               'Point',      // GeoJSON — enables $near queries
    coordinates:        [Number, Number]  // [longitude, latitude]
  },
  geofenceRadiusMetres: Number,       // default: 100, min: 10, max: 5000
  qrCodeToken:          String,       // UUID v4, unique, indexed; secret — rotatable
  createdAt:            Date,
  updatedAt:            Date
}
```

**Indexes**:
- `{ location: '2dsphere' }` — geospatial queries (optional, used if server validates geofence)
- `{ qrCodeToken: 1 }` — unique, lookup on QR scan validation

---

## 3. `attendance_records`

One document per employee per calendar day. Status machine:

```
open → closed          (normal: checkout received)
open → incomplete      (no checkout by midnight)
incomplete → closed    (admin manually closes)
```

```typescript
{
  _id:                    ObjectId,
  employeeId:             ObjectId,   // ref: employees, indexed
  workplaceId:            ObjectId,   // ref: workplaces
  date:                   String,     // 'YYYY-MM-DD', indexed; check-in date

  // Timestamps (server-assigned, not device clock)
  checkInAt:              Date,       // required on creation
  checkOutAt:             Date | null, // null until checkout or admin close

  // Status
  status: 'open' | 'closed' | 'incomplete',  // default: 'open'

  // Pay computation (populated when status → 'closed')
  regularHours:           Number | null,
  overtimeHoursMorning:   Number | null,  // hours before 08:00
  overtimeHoursEvening:   Number | null,  // hours after 17:00

  // Audit
  isManuallyAdjusted:     Boolean,    // default: false
  adjustmentNote:         String | null,
  adjustedBy:             ObjectId | null,  // ref: employees (admin)
  adjustedAt:             Date | null,

  // Sync metadata
  deviceCheckInAt:        Date,       // original device timestamp (for audit)
  deviceCheckOutAt:       Date | null,
  checkInLocation: {                  // GPS at time of scan
    lat: Number,
    lng: Number
  },

  createdAt:              Date,
  updatedAt:              Date
}
```

**Indexes**:
- `{ employeeId: 1, date: 1 }` — unique compound (one record per employee per day)
- `{ date: 1, workplaceId: 1 }` — dashboard daily overview
- `{ status: 1, date: 1 }` — find incomplete records

**Pay calculation** (populated on checkout):
- `regularHours` = overlap minutes of [checkInAt, checkOutAt] with [08:00, 17:00] ÷ 60
- `overtimeHoursMorning` = minutes before 08:00 ÷ 60, rounded to nearest 0.5
- `overtimeHoursEvening` = minutes after 17:00 ÷ 60, rounded to nearest 0.5

---

## 4. `paysheets`

Aggregation export document. Entries are embedded (snapshot at generation time).

```typescript
{
  _id:           ObjectId,
  generatedBy:   ObjectId,   // ref: employees (admin)
  generatedAt:   Date,
  periodStart:   String,     // 'YYYY-MM-DD'
  periodEnd:     String,     // 'YYYY-MM-DD'
  employeeIds:   [ObjectId], // employees included

  entries: [
    {
      employeeId:           ObjectId,
      employeeName:         String,   // snapshot at generation time
      date:                 String,   // 'YYYY-MM-DD'
      checkInAt:            Date,
      checkOutAt:           Date,
      regularHours:         Number,
      overtimeHoursMorning: Number,
      overtimeHoursEvening: Number,
      regularPay:           Number,   // 1000 or 0
      overtimePay:          Number,   // (morning + evening OT hours) × 160
      totalPay:             Number,
      isManuallyAdjusted:   Boolean,
      recordStatus:         'included' | 'skipped_incomplete'
    }
  ],

  totals: {
    totalRegularPay: Number,
    totalOvertimePay: Number,
    totalPayable: Number,
    skippedDays: Number
  },

  status:    'draft' | 'processed',   // default: 'draft'
  createdAt: Date,
  updatedAt: Date
}
```

---

## 5. `refresh_tokens`

Stores hashed refresh tokens for revocation support.

```typescript
{
  _id:        ObjectId,
  employeeId: ObjectId,   // ref: employees, indexed
  tokenHash:  String,     // SHA-256 hash of the refresh token
  expiresAt:  Date,       // TTL index — auto-deleted after 7 days
  createdAt:  Date,
  userAgent:  String | null,
  ipAddress:  String | null
}
```

**Indexes**:
- `{ tokenHash: 1 }` — unique, lookup on token refresh
- `{ expiresAt: 1 }` — TTL index (auto-expires tokens)

---

## State Transitions

### AttendanceRecord Status

```
[Employee arrives, scans QR]
         │
         ▼
      ┌──────┐
      │ open │
      └──────┘
         │
         ├─── [Employee scans QR at end of day] ──────► ┌────────┐
         │                                               │ closed │
         │                                               └────────┘
         │
         └─── [Midnight, no checkout recorded] ─────► ┌────────────┐
                                                       │ incomplete │
                                                       └────────────┘
                                                              │
                                                [Admin manually closes]
                                                              │
                                                              ▼
                                                        ┌────────┐
                                                        │ closed │
                                                        └────────┘
```

---

## Pay Rate Constants (backend config)

```typescript
export const PAY_RATES = {
  REGULAR_DAY_RATE:   1000,   // Rs per day (flat)
  OVERTIME_RATE:      160,    // Rs per hour
  REGULAR_START_HOUR: 8,      // 08:00
  REGULAR_END_HOUR:   17,     // 17:00
  OT_ROUNDING_MINS:   30,     // round overtime to nearest 30 min
} as const;
```
