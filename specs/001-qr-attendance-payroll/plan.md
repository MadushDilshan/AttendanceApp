# Implementation Plan: QR-Based Attendance & Payroll System

**Branch**: `001-qr-attendance-payroll` | **Date**: 2026-02-13 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-qr-attendance-payroll/spec.md`

---

## Summary

Build a geofence-enforced, QR-code-based employee attendance system with:
- **Flutter Android app** — employees check in/out by scanning a workplace QR code;
  geolocation gates the check-in button; offline events queued and synced automatically.
- **Node.js + Express REST API** — hosted on Render.com free tier; MongoDB Atlas (M0 free)
  as the database; JWT authentication with refresh tokens.
- **React + TypeScript web dashboard** — owner monitors attendance in real time, manually
  resolves incomplete records, and generates exportable paysheets (PDF/CSV).

Pay rule: Rs 1,000/day for regular hours (08:00–17:00) + Rs 160/hr for overtime.
Total hosting cost: **$0/month** at launch (MongoDB Atlas M0 + Render free + Vercel free).

---

## Technical Context

**Language/Version**: Dart 3.x (Flutter) + TypeScript 5.x (Node.js + React)
**Primary Dependencies**: Flutter 3.x + Express 4.x + React 18 + Mongoose 8.x + Riverpod + Vite
**Storage**: MongoDB Atlas M0 Free (cloud.mongodb.com)
**Testing**: flutter_test + Jest 29 + React Testing Library
**Target Platform**: Android 8.0+ (API 26) + Node.js 20 LTS (Render.com) + Web (Vercel)
**Project Type**: mobile + api + web
**Performance Goals**: Check-in flow < 30 s; dashboard refresh < 5 s; paysheet generation < 10 s
**Constraints**: Offline-capable mobile; HTTPS-only everywhere; minimum hosting cost ($0/month); JWT tokens with defined expiry
**Scale/Scope**: < 100 employees; single workplace initially; single admin account

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|---|---|---|
| I. Dual-Platform Coherence | ✅ PASS | Flutter Android + React Web + shared REST API. No third surface. |
| II. Quality-First Code | ✅ PASS | `flutter analyze` gate; TypeScript strict mode; ESLint; OpenAPI contract in `/contracts/api.yaml`. |
| III. Test-Driven Development | ✅ PASS | `flutter_test` (≥70% on services/repositories/providers); Jest (≥70% on backend services + React hooks). Integration test covers full check-in flow. |
| IV. Security & Privacy by Default | ✅ PASS | HTTPS-only; JWT in `flutter_secure_storage` / HttpOnly cookie; bcrypt passwords; RBAC (admin vs employee). |
| V. Offline-Aware Mobile Design | ✅ PASS | Hive local queue; connectivity_plus; auto-sync on reconnect; "Pending Sync" UI indicator; server timestamp wins. |
| VI. Simplicity & YAGNI | ✅ PASS | One workplace, one QR, Express (not NestJS). All packages vetted (releases within 12 months). |
| VII. Observability & Auditability | ✅ PASS | Morgan structured logs on backend; audit trail collection for manual adjustments; Firebase Crashlytics in Flutter release builds. |

**Post-Phase 1 re-check**: All principles still satisfied. No complexity violations.

---

## Project Structure

### Documentation (this feature)

```text
specs/001-qr-attendance-payroll/
├── plan.md              # This file
├── research.md          # Phase 0 — technology decisions
├── data-model.md        # Phase 1 — MongoDB schemas + state machines
├── quickstart.md        # Phase 1 — local dev + production setup
├── contracts/
│   └── api.yaml         # OpenAPI 3.1 — all 20 endpoints
└── tasks.md             # Phase 2 — generated by /speckit.tasks
```

### Source Code (repository root)

```text
android/                          # Flutter Android application
├── lib/
│   ├── core/
│   │   ├── config/
│   │   │   └── app_config.dart           # API base URL, constants
│   │   ├── network/
│   │   │   ├── api_client.dart           # Dio HTTP client + auth interceptor
│   │   │   └── connectivity_service.dart # connectivity_plus wrapper
│   │   ├── storage/
│   │   │   ├── secure_storage.dart       # flutter_secure_storage wrapper
│   │   │   └── offline_queue.dart        # Hive-based event queue
│   │   └── utils/
│   │       └── pay_calculator.dart       # Offline pay summary helper
│   ├── features/
│   │   ├── auth/
│   │   │   ├── data/                     # auth_repository.dart
│   │   │   ├── providers/                # auth_provider.dart (Riverpod)
│   │   │   └── screens/                  # login_screen.dart
│   │   ├── attendance/
│   │   │   ├── data/                     # attendance_repository.dart
│   │   │   ├── providers/                # attendance_provider.dart, geofence_provider.dart
│   │   │   └── screens/
│   │   │       ├── home_screen.dart      # Check In / Check Out + status
│   │   │       └── summary_screen.dart   # Daily summary after checkout
│   │   └── profile/
│   │       └── screens/                  # Profile + logout
│   └── main.dart
└── test/
    ├── unit/                             # Repository + service tests
    └── widget/                           # Widget tests for screens

backend/                          # Node.js + Express + TypeScript API
├── src/
│   ├── config/
│   │   ├── database.ts                   # Mongoose connection
│   │   └── env.ts                        # Zod-validated env vars
│   ├── models/
│   │   ├── Employee.ts                   # Mongoose schema + model
│   │   ├── Workplace.ts
│   │   ├── AttendanceRecord.ts
│   │   ├── PaySheet.ts
│   │   └── RefreshToken.ts
│   ├── routes/
│   │   ├── auth.routes.ts
│   │   ├── attendance.routes.ts          # Employee check-in/out/sync
│   │   └── admin/
│   │       ├── employees.routes.ts
│   │       ├── attendance.routes.ts
│   │       ├── workplace.routes.ts
│   │       └── paysheets.routes.ts
│   ├── services/
│   │   ├── auth.service.ts               # JWT sign/verify/refresh
│   │   ├── attendance.service.ts         # Business logic for check-in/out
│   │   ├── geofence.service.ts           # QR token validation
│   │   ├── payroll.service.ts            # Pay calculation engine
│   │   └── export.service.ts             # PDF + CSV generation
│   ├── middleware/
│   │   ├── authenticate.ts               # JWT verification middleware
│   │   ├── authorize.ts                  # Role-based access (admin only)
│   │   ├── validate.ts                   # Zod request validation
│   │   └── errorHandler.ts               # Global error handler
│   ├── utils/
│   │   └── dateUtils.ts                  # UTC date helpers
│   ├── scripts/
│   │   └── seed.ts                       # Initial data seed
│   └── index.ts                          # Express app entry point
├── tests/
│   ├── unit/
│   │   ├── payroll.service.test.ts       # Pay calc unit tests (no DB)
│   │   └── dateUtils.test.ts
│   └── integration/
│       ├── auth.test.ts                  # Full login/refresh flow
│       ├── attendance.test.ts            # Check-in/out + sync flow
│       └── paysheets.test.ts             # Paysheet generation
├── package.json
├── tsconfig.json
├── jest.config.ts
└── .env.example

web/                              # React + TypeScript dashboard (Vite)
├── src/
│   ├── components/
│   │   ├── ui/                           # Button, Table, Badge, Modal, etc.
│   │   ├── AttendanceTable.tsx
│   │   ├── EmployeeStatusCard.tsx
│   │   ├── PaysheetTable.tsx
│   │   └── QRCodeDisplay.tsx
│   ├── pages/
│   │   ├── LoginPage.tsx
│   │   ├── DashboardPage.tsx             # Today's attendance overview
│   │   ├── AttendancePage.tsx            # History + manual close
│   │   ├── EmployeesPage.tsx             # CRUD employee accounts
│   │   ├── PaysheetPage.tsx              # Generate + export
│   │   └── SettingsPage.tsx              # Workplace config + QR
│   ├── services/
│   │   ├── apiClient.ts                  # Axios + auth interceptor
│   │   ├── authService.ts
│   │   ├── attendanceService.ts
│   │   ├── employeeService.ts
│   │   ├── paySheetsService.ts
│   │   └── workplaceService.ts
│   ├── store/
│   │   ├── authStore.ts                  # Zustand auth store
│   │   └── uiStore.ts                    # Notification/toast state
│   ├── hooks/
│   │   ├── useAuth.ts
│   │   ├── useAttendance.ts
│   │   └── usePaysheet.ts
│   ├── types/
│   │   └── api.types.ts                  # TypeScript types from OpenAPI contract
│   ├── App.tsx
│   └── main.tsx
├── tests/
│   ├── unit/                             # Hook + service tests
│   └── components/                       # Component render tests
├── package.json
├── tsconfig.json
├── vite.config.ts
└── .env.example
```

**Structure Decision**: Option 3 (Mobile + API + Web) — three separate project roots at
`android/`, `backend/`, and `web/` in the repository root. This maps directly to the three
deployment targets (Play Store / Render.com / Vercel) and keeps concerns cleanly separated.

---

## Complexity Tracking

> No constitution violations requiring justification. Three project roots are the minimum
> required for this architecture (one per deployment target). This is explicitly supported by
> the plan template's Option 3.

---

## Phase 0: Research Summary

All technology decisions resolved. See [research.md](./research.md) for full rationale.

| Decision | Choice | Cost |
|---|---|---|
| Mobile | Flutter 3.x + Riverpod + Hive + mobile_scanner | $0 |
| Backend | Node.js 20 + Express 4 + TypeScript 5 | $0 |
| Database | MongoDB Atlas M0 (512 MB, cloud-hosted) | $0 |
| Backend hosting | Render.com Free Web Service | $0 |
| Dashboard hosting | Vercel Hobby Free | $0 |
| Auth | JWT (15 min access + 7 day refresh) | $0 |
| Email | Brevo free tier (password reset) | $0 |
| **Total** | | **$0/month** |

---

## Phase 1: Design Summary

### Data Model
See [data-model.md](./data-model.md).

Five MongoDB collections:
- `employees` — accounts for both employees and admins
- `workplaces` — one document per premises with QR token and geofence config
- `attendance_records` — one per employee per day; status machine: open → closed/incomplete
- `paysheets` — embedded pay entries snapshot at generation time
- `refresh_tokens` — hashed tokens with TTL auto-expiry

### API Contracts
See [contracts/api.yaml](./contracts/api.yaml).

20 endpoints across 6 tag groups:
- `auth` (3): login, refresh, logout
- `attendance` (4): today, check-in, check-out, bulk sync
- `admin-employees` (3): list, create, update/deactivate
- `admin-attendance` (3): query, today overview, manual close
- `admin-workplace` (3): get, update, QR image, QR rotate
- `admin-paysheets` (4): generate, get, mark processed, export

### Quickstart
See [quickstart.md](./quickstart.md) — covers local setup for all three components and
production deployment to MongoDB Atlas + Render.com + Vercel.

---

## Implementation Phases (preview for /speckit.tasks)

### Phase 1: Shared Setup
- Initialize `backend/` Node.js + TypeScript project
- Initialize `web/` Vite + React + TypeScript project
- Initialize `android/` Flutter project
- Configure MongoDB Atlas and obtain connection string

### Phase 2: Foundation (blocks all user stories)
- Backend: database connection, Mongoose models, auth middleware, error handling
- Backend: seed script (workplace + admin account)

### Phase 3: US1 — Employee Check-In (P1 MVP)
- Backend: `POST /api/attendance/checkin` endpoint + service
- Backend: QR token validation
- Flutter: geofence provider (geolocator)
- Flutter: QR scan screen (mobile_scanner)
- Flutter: attendance repository + check-in provider
- Flutter: home screen with Check In button state logic

### Phase 4: US2 — Employee Check-Out (P1)
- Backend: `POST /api/attendance/checkout` + pay calculation service
- Backend: midnight incomplete flag job (scheduled with `node-cron`)
- Flutter: Check Out button + daily summary screen
- Flutter: offline queue (Hive) + sync on reconnect

### Phase 5: US3 — Owner Dashboard (P2)
- Backend: admin attendance query endpoints
- Backend: today overview endpoint
- Backend: manual close endpoint + audit log
- React: Login page + auth store
- React: Dashboard page (today's overview table)
- React: Attendance history page + manual close modal
- React: Employee management page

### Phase 6: US4 — Pay Sheet Generation (P3)
- Backend: payroll calculation service (full algorithm)
- Backend: paysheet generate + export (PDF + CSV)
- React: Paysheet page + date range selector
- React: Export buttons (PDF/CSV download)

### Phase 7: Settings + Admin
- React: Settings page (workplace location, geofence radius, QR rotate)
- React: QR code display + print view
- Backend: workplace update endpoints

### Phase N: Polish
- Documentation, lint/test coverage gates, production env setup
